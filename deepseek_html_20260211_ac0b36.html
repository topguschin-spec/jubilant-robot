<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* –°–¢–ò–õ–ò CSS */
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #d97706;
            --info: #0ea5e9;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-light: #f8fafc;
            --text-error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1e1b4b 100%);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 1em;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .system-info {
            font-size: 1em;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .system-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .card h2 {
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .sensors-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .sensor-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .sensor-card.error {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .sensor-card.warning {
            border-color: var(--warning);
            background: rgba(217, 119, 6, 0.1);
        }

        .sensor-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .sensor-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
            min-height: 1.5em;
        }

        .sensor-value.error {
            color: var(--danger);
        }

        .sensor-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .motor-control {
            grid-template-columns: repeat(3, 1fr);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .status-indicators {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }

        .status-item {
            text-align: center;
        }

        .status-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .status-value {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
            position: relative;
        }

        .alert-banner {
            background: var(--danger);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .system-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status-normal { background: var(--success); }
        .status-warning { background: var(--warning); }
        .status-danger { background: var(--danger); }
        .status-error { background: #6b7280; }

        .lcd-input {
            grid-column: 1 / -1;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
            margin-top: 10px;
        }

        .lcd-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .data-error {
            color: var(--danger);
            font-style: italic;
            text-align: center;
            padding: 10px;
        }

        .connection-status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
        }

        .connection-status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
        }

        .connection-status.warning {
            background: rgba(217, 119, 6, 0.1);
            border: 1px solid var(--warning);
        }

        .last-update {
            text-align: center;
            font-size: 0.85em;
            opacity: 0.7;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üöÄ –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h1>
            <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
            <div class="system-info">
                <div class="system-info-item">
                    <span>–°—Ç–∞—Ç—É—Å:</span>
                    <span id="system-status" class="system-status status-error">–ù–ï–¢ –î–ê–ù–ù–´–•</span>
                </div>
                <div class="system-info-item">
                    <span>–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä:</span>
                    <span id="fan-status">–ù–ï–¢ –î–ê–ù–ù–´–•</span>
                </div>
                <div class="system-info-item">
                    <span>–ú–æ—Ç–æ—Ä:</span>
                    <span id="motor-status">–ù–ï–¢ –î–ê–ù–ù–´–•</span>
                </div>
                <div class="system-info-item">
                    <span>Arduino:</span>
                    <span id="arduino-status-text">‚ùå –û–¢–ö–õ–Æ–ß–ï–ù</span>
                </div>
            </div>
        </header>

        <div class="connection-status error" id="connection-status">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <span class="loading"></span>
                <span>üîç –ü–æ–∏—Å–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Arduino...</span>
            </div>
            <div style="margin-top: 10px; font-size: 0.9em;">
                –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Python –±–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ Arduino –ø–æ–¥–∫–ª—é—á–µ–Ω
            </div>
        </div>

        <div class="dashboard">
            <!-- –ö–∞—Ä—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–∞—Ç—á–∏–∫–æ–≤ -->
            <div class="card">
                <h2>üìä –î–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤</h2>
                <div class="sensors-grid">
                    <div class="sensor-card error" id="temp-card">
                        <div class="sensor-icon">üå°</div>
                        <div class="sensor-value error" id="temperature">--</div>
                        <div class="sensor-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
                        <div class="data-error" id="temp-error">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å DHT22</div>
                    </div>
                    <div class="sensor-card error" id="hum-card">
                        <div class="sensor-icon">üíß</div>
                        <div class="sensor-value error" id="humidity">--</div>
                        <div class="sensor-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
                        <div class="data-error" id="hum-error">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å DHT22</div>
                    </div>
                    <div class="sensor-card error" id="light-card">
                        <div class="sensor-icon">üí°</div>
                        <div class="sensor-value error" id="light">--</div>
                        <div class="sensor-label">–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å</div>
                        <div class="data-error" id="light-error">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å BH1750</div>
                    </div>
                    <div class="sensor-card" id="voltage-card">
                        <div class="sensor-icon">üîã</div>
                        <div class="sensor-value" id="voltage">5.0V</div>
                        <div class="sensor-label">–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á.)</div>
                    </div>
                </div>

                <div class="status-indicators">
                    <div class="status-item">
                        <div class="status-header">
                            <span>üì∂ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Arduino</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="arduino-progress" style="width: 0%; background: #60a5fa;"></div>
                        </div>
                        <div class="status-value" id="arduino-detail">COM6 –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>
                    </div>
                    <div class="status-item">
                        <div class="status-header">
                            <span id="light-emoji">‚ö´</span>
                            <span>–£—Ä–æ–≤–µ–Ω—å –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="light-progress" style="width: 0%; background: #fbbf24;"></div>
                        </div>
                        <div class="status-value" id="light-level">–î–∞—Ç—á–∏–∫ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç</div>
                    </div>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="card">
                <h2>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π</h2>
                
                <div class="control-panel">
                    <button class="btn btn-primary" onclick="toggleFan()" id="fan-btn" disabled>
                        üåÄ –í–ö–õ –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä
                    </button>
                    <button class="btn btn-success" onclick="requestDataFromBot()" id="refresh-btn">
                        <span class="loading" id="refresh-loading" style="display: none;"></span>
                        üîÑ –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                </div>

                <h2 style="margin-top: 30px;">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ—Ç–æ—Ä–æ–º</h2>
                <div class="control-panel motor-control">
                    <button class="btn btn-primary" onclick="motorForward()" id="motor-forward" disabled>
                        üîÑ –í–ü–ï–†–Å–î
                    </button>
                    <button class="btn btn-warning" onclick="motorBackward()" id="motor-backward" disabled>
                        ‚Ü©Ô∏è –ù–ê–ó–ê–î
                    </button>
                    <button class="btn btn-danger" onclick="motorStop()" id="motor-stop" disabled>
                        ‚èπÔ∏è –°–¢–û–ü
                    </button>
                </div>

                <h2 style="margin-top: 30px;">üìà –ì—Ä–∞—Ñ–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h2>
                <div class="chart-container">
                    <canvas id="data-chart"></canvas>
                </div>
                <div class="last-update">
                    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞: <span id="chart-update-time">–Ω–∏–∫–æ–≥–¥–∞</span>
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏—Å—Ç–µ–º–µ -->
        <div class="card">
            <h2>üõ∞ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ</h2>
            <div class="sensors-grid">
                <div class="sensor-card">
                    <div class="sensor-icon">üïê</div>
                    <div class="sensor-value" id="update-time">--:--:--</div>
                    <div class="sensor-label">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ</div>
                </div>
                <div class="sensor-card">
                    <div class="sensor-icon">üì°</div>
                    <div class="sensor-value" id="sensor-connection">–ù–ï–¢</div>
                    <div class="sensor-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
                <div class="sensor-card">
                    <div class="sensor-icon">‚ö°</div>
                    <div class="sensor-value" id="signal-level">--%</div>
                    <div class="sensor-label">–°–∏–≥–Ω–∞–ª</div>
                </div>
                <div class="sensor-card">
                    <div class="sensor-icon">üõ∞</div>
                    <div class="sensor-value">DHT22+BH1750</div>
                    <div class="sensor-label">–î–∞—Ç—á–∏–∫–∏</div>
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è LCD -->
        <div class="card">
            <h2>üì∫ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ LCD –¥–∏—Å–ø–ª–µ–µ–º</h2>
            <div class="control-panel">
                <button class="btn btn-primary" onclick="sendToLCD('data')" id="lcd-data" disabled>
                    üìä –î–∞–Ω–Ω—ã–µ –Ω–∞ LCD
                </button>
                <button class="btn btn-warning" onclick="sendToLCD('test')" id="lcd-test" disabled>
                    üì° –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                </button>
                <button class="btn btn-danger" onclick="sendToLCD('clear')" id="lcd-clear" disabled>
                    üßπ –û—á–∏—Å—Ç–∏—Ç—å LCD
                </button>
                <input type="text" id="lcd-message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è LCD..." 
                       class="lcd-input" disabled>
                <button class="btn btn-success" onclick="sendCustomLCD()" id="lcd-send" disabled>
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
            <div class="last-update">
                LCD —Å—Ç–∞—Ç—É—Å: <span id="lcd-status">–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>
            </div>
        </div>

        <div class="last-update" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <div>–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</div>
            <div>–î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–π Python –±–æ—Ç —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º Arduino</div>
            <div id="webapp-status">Telegram WebApp: –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω (—Ä–∞–±–æ—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)</div>
        </div>
    </div>

    <!-- –í–ï–°–¨ JAVASCRIPT –ö–û–î -->
    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const CONFIG = {
            SENSOR_TIMEOUT: 10000, // 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            AUTO_REFRESH: 30000,   // 30 —Å–µ–∫—É–Ω–¥ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            MAX_DATA_POINTS: 50    // –ú–∞–∫—Å–∏–º—É–º —Ç–æ—á–µ–∫ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
        };

        // ==================== –°–û–°–¢–û–Ø–ù–ò–ï –°–ò–°–¢–ï–ú–´ ====================
        let systemState = {
            // –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –∏–∑ –±–æ—Ç–∞)
            temperature: null,
            humidity: null,
            light: null,
            voltage: 5.0,
            signal_level: 0,
            
            // –°—Ç–∞—Ç—É—Å—ã
            fan_status: null,
            motor_status: null,
            system_status: '–ù–ï–¢ –î–ê–ù–ù–´–•',
            arduino_connected: false,
            sensor_connection: '–ù–ï–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø',
            light_text: '–ù–ï–¢ –î–ê–ù–ù–´–•',
            
            // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            last_update: null,
            data_age: Infinity,
            is_online: false,
            
            // –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
            history: {
                timestamps: [],
                temperatures: [],
                humidity: [],
                light: []
            }
        };

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        const tg = window.Telegram?.WebApp;
        let chart = null;
        let lastRequestTime = 0;
        const REQUEST_COOLDOWN = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram WebApp –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if (tg) {
                tg.expand();
                tg.BackButton.show();
                tg.BackButton.onClick(() => tg.close());
                updateWebAppStatus('Telegram WebApp: –∞–∫—Ç–∏–≤–µ–Ω ‚úì');
            } else {
                updateWebAppStatus('Telegram WebApp: –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω (—Ä–∞–±–æ—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)');
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            initChart();
            
            // –ù–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            updateUI();
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            updateConnectionStatus();
            
            // –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä debug, –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (window.location.search.includes('debug')) {
                showNotification('–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –∞–∫—Ç–∏–≤–µ–Ω', 'info');
            }
            
            console.log('üöÄ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            console.log('‚ö†Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Python –±–æ—Ç–∞...');
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ì–†–ê–§–ò–ö–ê ====================
        function initChart() {
            const ctx = document.getElementById('data-chart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3,
                            fill: true,
                            borderWidth: 2,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        },
                        {
                            label: '–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å (–ª–∫)',
                            data: [],
                            borderColor: '#fbbf24',
                            backgroundColor: 'rgba(251, 191, 36, 0.1)',
                            tension: 0.3,
                            fill: true,
                            borderWidth: 2,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            yAxisID: 'y1'
                        },
                        {
                            label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)',
                            data: [],
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            tension: 0.3,
                            fill: true,
                            borderWidth: 2,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            display: true,
                            title: {
                                display: true,
                                text: '–í—Ä–µ–º—è',
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)',
                                maxRotation: 0
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/–í–ª–∞–∂–Ω–æ—Å—Ç—å',
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å (–ª–∫)',
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ====================
        function updateUI() {
            const now = Date.now();
            systemState.data_age = systemState.last_update ? 
                (now - systemState.last_update) : Infinity;
            
            const isDataFresh = systemState.data_age < CONFIG.SENSOR_TIMEOUT;
            const hasArduino = systemState.arduino_connected;
            const hasSensorData = systemState.temperature !== null && 
                                 systemState.humidity !== null && 
                                 systemState.light !== null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
            updateSystemStatus(isDataFresh, hasArduino, hasSensorData);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤
            updateSensorDisplay();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
            updateIndicators();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            updateChart();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            updateControlButtons(hasArduino && isDataFresh);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            updateConnectionStatus();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
            updateTimeDisplay();
        }

        function updateSystemStatus(isFresh, hasArduino, hasData) {
            const statusEl = document.getElementById('system-status');
            let status = '–ù–ï–¢ –î–ê–ù–ù–´–•';
            let statusClass = 'status-error';
            
            if (!hasArduino) {
                status = 'ARDUINO –û–¢–ö–õ–Æ–ß–ï–ù';
                statusClass = 'status-error';
                systemState.system_status = '–û–®–ò–ë–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø';
            } else if (!isFresh) {
                status = '–î–ê–ù–ù–´–ï –£–°–¢–ê–†–ï–õ–ò';
                statusClass = 'status-warning';
                systemState.system_status = '–ù–ï–¢ –û–ë–ù–û–í–õ–ï–ù–ò–ô';
            } else if (!hasData) {
                status = '–ù–ï–¢ –î–ê–ù–ù–´–• –î–ê–¢–ß–ò–ö–û–í';
                statusClass = 'status-warning';
                systemState.system_status = '–û–®–ò–ë–ö–ê –î–ê–¢–ß–ò–ö–û–í';
            } else {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ (–∫–∞–∫ –≤ Python –±–æ—Ç–µ)
                if (systemState.temperature > 27) {
                    status = '–û–ü–ê–°–ù–û–°–¢–¨';
                    statusClass = 'status-danger';
                } else if (systemState.temperature > 25) {
                    status = '–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï';
                    statusClass = 'status-warning';
                } else {
                    status = '–ù–û–†–ú–ê';
                    statusClass = 'status-normal';
                }
                systemState.system_status = status;
            }
            
            statusEl.textContent = status;
            statusEl.className = `system-status ${statusClass}`;
        }

        function updateSensorDisplay() {
            // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
            const tempEl = document.getElementById('temperature');
            const tempCard = document.getElementById('temp-card');
            const tempError = document.getElementById('temp-error');
            
            if (systemState.temperature !== null && systemState.data_age < CONFIG.SENSOR_TIMEOUT) {
                tempEl.textContent = `${systemState.temperature}¬∞C`;
                tempEl.className = 'sensor-value';
                tempCard.className = 'sensor-card';
                tempError.style.display = 'none';
            } else {
                tempEl.textContent = '--';
                tempEl.className = 'sensor-value error';
                tempCard.className = 'sensor-card error';
                tempError.style.display = 'block';
                tempError.textContent = systemState.temperature === null ? 
                    '–î–∞—Ç—á–∏–∫ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏';
            }
            
            // –í–ª–∞–∂–Ω–æ—Å—Ç—å
            const humEl = document.getElementById('humidity');
            const humCard = document.getElementById('hum-card');
            const humError = document.getElementById('hum-error');
            
            if (systemState.humidity !== null && systemState.data_age < CONFIG.SENSOR_TIMEOUT) {
                humEl.textContent = `${systemState.humidity}%`;
                humEl.className = 'sensor-value';
                humCard.className = 'sensor-card';
                humError.style.display = 'none';
            } else {
                humEl.textContent = '--';
                humEl.className = 'sensor-value error';
                humCard.className = 'sensor-card error';
                humError.style.display = 'block';
                humError.textContent = systemState.humidity === null ? 
                    '–î–∞—Ç—á–∏–∫ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏';
            }
            
            // –û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å
            const lightEl = document.getElementById('light');
            const lightCard = document.getElementById('light-card');
            const lightError = document.getElementById('light-error');
            
            if (systemState.light !== null && systemState.data_age < CONFIG.SENSOR_TIMEOUT) {
                lightEl.textContent = `${systemState.light} –ª–∫`;
                lightEl.className = 'sensor-value';
                lightCard.className = 'sensor-card';
                lightError.style.display = 'none';
            } else {
                lightEl.textContent = '--';
                lightEl.className = 'sensor-value error';
                lightCard.className = 'sensor-card error';
                lightError.style.display = 'block';
                lightError.textContent = systemState.light === null ? 
                    '–î–∞—Ç—á–∏–∫ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏';
            }
            
            // –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ
            document.getElementById('voltage').textContent = `${systemState.voltage}V`;
            
            // –°—Ç–∞—Ç—É—Å—ã
            document.getElementById('fan-status').textContent = 
                systemState.fan_status !== null ? 
                (systemState.fan_status ? '–í–ö–õ' : '–í–´–ö–õ') : '–ù–ï–¢ –î–ê–ù–ù–´–•';
            
            document.getElementById('motor-status').textContent = 
                systemState.motor_status || '–ù–ï–¢ –î–ê–ù–ù–´–•';
            
            document.getElementById('sensor-connection').textContent = 
                systemState.sensor_connection;
            
            document.getElementById('signal-level').textContent = 
                systemState.signal_level > 0 ? `${systemState.signal_level}%` : '--%';
        }

        function updateIndicators() {
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä Arduino
            const arduinoProgress = document.getElementById('arduino-progress');
            const arduinoDetail = document.getElementById('arduino-detail');
            const arduinoStatusText = document.getElementById('arduino-status-text');
            
            if (systemState.arduino_connected && systemState.data_age < CONFIG.SENSOR_TIMEOUT) {
                arduinoProgress.style.width = '100%';
                arduinoProgress.style.background = '#10b981';
                arduinoDetail.textContent = 'COM6 –ø–æ–¥–∫–ª—é—á–µ–Ω ‚úì';
                arduinoStatusText.textContent = '‚úÖ –ü–û–î–ö–õ–Æ–ß–ï–ù';
                arduinoStatusText.style.color = '#10b981';
            } else if (systemState.arduino_connected) {
                arduinoProgress.style.width = '50%';
                arduinoProgress.style.background = '#f59e0b';
                arduinoDetail.textContent = 'COM6: –Ω–µ—Ç —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö';
                arduinoStatusText.textContent = '‚ö†Ô∏è –ù–ï–¢ –î–ê–ù–ù–´–•';
                arduinoStatusText.style.color = '#f59e0b';
            } else {
                arduinoProgress.style.width = '10%';
                arduinoProgress.style.background = '#ef4444';
                arduinoDetail.textContent = 'COM6 –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
                arduinoStatusText.textContent = '‚ùå –û–¢–ö–õ–Æ–ß–ï–ù';
                arduinoStatusText.style.color = '#ef4444';
            }
            
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏
            const lightProgress = document.getElementById('light-progress');
            const lightLevel = document.getElementById('light-level');
            const lightEmoji = document.getElementById('light-emoji');
            
            if (systemState.light !== null && systemState.data_age < CONFIG.SENSOR_TIMEOUT) {
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ (0-10000 –ª–∫ -> 0-100%)
                let percentage = Math.min(100, (systemState.light / 10000) * 100);
                lightProgress.style.width = percentage + '%';
                lightLevel.textContent = systemState.light_text;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–º–æ–¥–∑–∏ –ø–æ —É—Ä–æ–≤–Ω—é —Å–≤–µ—Ç–∞
                const lux = systemState.light;
                if (lux < 50) {
                    lightEmoji.textContent = 'üåë';
                    lightProgress.style.background = '#4b5563';
                } else if (lux < 150) {
                    lightEmoji.textContent = 'üåí';
                    lightProgress.style.background = '#6b7280';
                } else if (lux < 300) {
                    lightEmoji.textContent = 'üåì';
                    lightProgress.style.background = '#9ca3af';
                } else if (lux < 500) {
                    lightEmoji.textContent = 'üåî';
                    lightProgress.style.background = '#fbbf24';
                } else if (lux < 750) {
                    lightEmoji.textContent = 'üí°';
                    lightProgress.style.background = '#fbbf24';
                } else if (lux < 1000) {
                    lightEmoji.textContent = 'üí°';
                    lightProgress.style.background = '#f59e0b';
                } else if (lux < 3000) {
                    lightEmoji.textContent = '‚òÄÔ∏è';
                    lightProgress.style.background = '#f59e0b';
                } else if (lux < 10000) {
                    lightEmoji.textContent = '‚òÄÔ∏è';
                    lightProgress.style.background = '#d97706';
                } else {
                    lightEmoji.textContent = '‚òÄÔ∏è‚òÄÔ∏è';
                    lightProgress.style.background = '#b45309';
                }
            } else {
                lightProgress.style.width = '0%';
                lightLevel.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                lightEmoji.textContent = '‚ö´';
                lightProgress.style.background = '#6b7280';
            }
        }

        function updateChart() {
            if (!chart) return;
            
            const now = new Date();
            const hasData = systemState.temperature !== null && 
                          systemState.humidity !== null && 
                          systemState.light !== null;
            
            if (hasData && systemState.data_age < CONFIG.SENSOR_TIMEOUT) {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                systemState.history.timestamps.push(now);
                systemState.history.temperatures.push(systemState.temperature);
                systemState.history.humidity.push(systemState.humidity);
                systemState.history.light.push(systemState.light);
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
                if (systemState.history.timestamps.length > CONFIG.MAX_DATA_POINTS) {
                    systemState.history.timestamps.shift();
                    systemState.history.temperatures.shift();
                    systemState.history.humidity.shift();
                    systemState.history.light.shift();
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
                chart.data.labels = systemState.history.timestamps;
                chart.data.datasets[0].data = systemState.history.temperatures;
                chart.data.datasets[1].data = systemState.history.light;
                chart.data.datasets[2].data = systemState.history.humidity;
                chart.update();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
                document.getElementById('chart-update-time').textContent = 
                    now.toLocaleTimeString();
            }
        }

        function updateControlButtons(isEnabled) {
            const buttons = [
                'fan-btn', 'motor-forward', 'motor-backward', 'motor-stop',
                'lcd-data', 'lcd-test', 'lcd-clear', 'lcd-send'
            ];
            
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = !isEnabled;
                }
            });
            
            // –ü–æ–ª–µ –≤–≤–æ–¥–∞ LCD
            const lcdInput = document.getElementById('lcd-message');
            if (lcdInput) {
                lcdInput.disabled = !isEnabled;
                lcdInput.placeholder = isEnabled ? 
                    '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è LCD...' : 
                    '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ LCD –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
            }
            
            // –°—Ç–∞—Ç—É—Å LCD
            document.getElementById('lcd-status').textContent = 
                isEnabled ? '–≥–æ—Ç–æ–≤' : '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
            document.getElementById('lcd-status').style.color = 
                isEnabled ? '#10b981' : '#ef4444';
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            const hasArduino = systemState.arduino_connected;
            const isFresh = systemState.data_age < CONFIG.SENSOR_TIMEOUT;
            const hasData = systemState.temperature !== null && 
                          systemState.humidity !== null && 
                          systemState.light !== null;
            
            let statusText = '';
            let statusClass = '';
            let details = '';
            
            if (!hasArduino) {
                statusText = '‚ùå Arduino –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
                statusClass = 'error';
                details = 'Python –±–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ COM6';
            } else if (!isFresh) {
                statusText = '‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏';
                statusClass = 'warning';
                details = `–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ: ${formatTimeAgo(systemState.last_update)}`;
            } else if (!hasData) {
                statusText = '‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤';
                statusClass = 'warning';
                details = 'DHT22 –∏–ª–∏ BH1750 –Ω–µ –æ—Ç–≤–µ—á–∞—é—Ç';
            } else {
                statusText = '‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ';
                statusClass = '';
                details = `–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã ${formatTimeAgo(systemState.last_update)}`;
            }
            
            statusEl.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    ${hasArduino && isFresh && hasData ? '‚úÖ' : 
                      hasArduino ? '‚ö†Ô∏è' : '‚ùå'}
                    <span>${statusText}</span>
                </div>
                <div style="margin-top: 10px; font-size: 0.9em;">${details}</div>
            `;
            statusEl.className = `connection-status ${statusClass}`;
        }

        function updateTimeDisplay() {
            const updateEl = document.getElementById('update-time');
            
            if (systemState.last_update) {
                const date = new Date(systemState.last_update);
                updateEl.textContent = date.toLocaleTimeString();
            } else {
                updateEl.textContent = '--:--:--';
            }
        }

        function updateWebAppStatus(text) {
            const el = document.getElementById('webapp-status');
            if (el) el.textContent = text;
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ====================
        function requestDataFromBot() {
            const now = Date.now();
            if (now - lastRequestTime < REQUEST_COOLDOWN) {
                showNotification('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–ø—Ä–æ—Å–æ–º', 'warning');
                return;
            }
            
            lastRequestTime = now;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingEl = document.getElementById('refresh-loading');
            const btn = document.getElementById('refresh-btn');
            if (loadingEl && btn) {
                loadingEl.style.display = 'inline-block';
                btn.disabled = true;
                
                // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    loadingEl.style.display = 'none';
                    btn.disabled = false;
                }, 3000);
            }
            
            // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤ Telegram –±–æ—Ç
            if (tg) {
                tg.sendData(JSON.stringify({ 
                    action: 'request_data',
                    timestamp: now 
                }));
                showNotification('–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É', 'info');
            } else {
                // –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                simulateDataFromBot();
                showNotification('–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö (—Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏)', 'info');
            }
        }

        function toggleFan() {
            if (!systemState.arduino_connected) {
                showNotification('Arduino –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                return;
            }
            
            const newState = systemState.fan_status !== null ? !systemState.fan_status : true;
            
            if (tg) {
                tg.sendData(JSON.stringify({ 
                    action: 'toggle_fan', 
                    status: newState 
                }));
                showNotification(`–ö–æ–º–∞–Ω–¥–∞ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä—É: ${newState ? '–í–ö–õ' : '–í–´–ö–õ'}`, 'info');
            } else {
                showNotification('–ö–æ–º–∞–Ω–¥–∞ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä—É (—Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏)', 'info');
            }
            
            // –õ–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            systemState.fan_status = newState;
            updateUI();
        }

        function motorForward() {
            sendMotorCommand('forward', 'üîÑ –ú–û–¢–û–† –í–ü–ï–†–Å–î');
        }

        function motorBackward() {
            sendMotorCommand('backward', '‚Ü™Ô∏è –ú–û–¢–û–† –ù–ê–ó–ê–î');
        }

        function motorStop() {
            sendMotorCommand('stop', '‚èπÔ∏è –ú–û–¢–û–† –°–¢–û–ü');
        }

        function sendMotorCommand(command, displayName) {
            if (!systemState.arduino_connected) {
                showNotification('Arduino –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                return;
            }
            
            if (tg) {
                tg.sendData(JSON.stringify({ 
                    action: 'motor_control', 
                    command: command 
                }));
                showNotification(`–ö–æ–º–∞–Ω–¥–∞: ${displayName}`, 'info');
            } else {
                showNotification(`–ö–æ–º–∞–Ω–¥–∞: ${displayName} (—Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏)`, 'info');
            }
            
            // –õ–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            systemState.motor_status = displayName.split(' ').slice(1).join(' ');
            updateUI();
        }

        function sendToLCD(type) {
            if (!systemState.arduino_connected) {
                showNotification('Arduino –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                return;
            }
            
            let message = '';
            switch(type) {
                case 'data':
                    message = `T:${systemState.temperature || 0}C H:${systemState.humidity || 0}%`;
                    break;
                case 'test':
                    message = '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥';
                    break;
                case 'clear':
                    message = '';
                    break;
            }
            
            if (tg) {
                tg.sendData(JSON.stringify({ 
                    action: 'lcd_control', 
                    type: type,
                    message: message 
                }));
                showNotification(`LCD: ${type === 'clear' ? '–æ—á–∏—Å—Ç–∫–∞' : '—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'}`, 'info');
            } else {
                showNotification(`LCD –∫–æ–º–∞–Ω–¥–∞ (—Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏): ${type}`, 'info');
            }
        }

        function sendCustomLCD() {
            const input = document.getElementById('lcd-message');
            const message = input.value.trim();
            
            if (!message) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è LCD', 'warning');
                return;
            }
            
            if (!systemState.arduino_connected) {
                showNotification('Arduino –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                return;
            }
            
            if (tg) {
                tg.sendData(JSON.stringify({ 
                    action: 'lcd_control', 
                    type: 'custom',
                    message: message 
                }));
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ LCD', 'info');
                input.value = '';
            } else {
                showNotification(`LCD —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏): "${message}"`, 'info');
                input.value = '';
            }
        }

        // ==================== –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• –û–¢ –ë–û–¢–ê ====================
        function updateFromBotData(data) {
            try {
                console.log('üì• –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç –±–æ—Ç–∞:', data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
                if (data.temperature !== undefined) systemState.temperature = parseFloat(data.temperature);
                if (data.humidity !== undefined) systemState.humidity = parseFloat(data.humidity);
                if (data.light !== undefined) systemState.light = parseFloat(data.light);
                if (data.voltage !== undefined) systemState.voltage = parseFloat(data.voltage);
                if (data.signal_level !== undefined) systemState.signal_level = parseInt(data.signal_level);
                
                if (data.fan_status !== undefined) {
                    systemState.fan_status = data.fan_status === true || data.fan_status === 'true' || data.fan_status === '–í–ö–õ';
                }
                
                if (data.motor_status !== undefined) systemState.motor_status = data.motor_status;
                if (data.system_status !== undefined) systemState.system_status = data.system_status;
                if (data.arduino_connected !== undefined) systemState.arduino_connected = data.arduino_connected === true || data.arduino_connected === 'true';
                if (data.sensor_connection !== undefined) systemState.sensor_connection = data.sensor_connection;
                if (data.light_text !== undefined) systemState.light_text = data.light_text;
                
                systemState.last_update = Date.now();
                systemState.is_online = true;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateUI();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                if (data.timestamp) {
                    const timeDiff = Date.now() - data.timestamp;
                    if (timeDiff < 10000) { // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–≤–µ–∂–∏–µ
                        showNotification('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                    }
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function formatTimeAgo(timestamp) {
            if (!timestamp) return '–Ω–∏–∫–æ–≥–¥–∞';
            
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            if (minutes > 0) {
                return `${minutes} –º–∏–Ω ${seconds} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
            } else {
                return `${seconds} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
            }
        }

        function showNotification(message, type = 'info') {
            if (!tg) {
                // –í –±—Ä–∞—É–∑–µ—Ä–µ –ø—Ä–æ—Å—Ç–æ alert –∏–ª–∏ console.log
                console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
                
                // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px;
                    background: ${type === 'error' ? '#ef4444' : 
                               type === 'warning' ? '#f59e0b' : 
                               type === 'success' ? '#10b981' : '#3b82f6'};
                    color: white;
                    border-radius: 10px;
                    z-index: 1000;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    max-width: 300px;
                    animation: slideIn 0.3s ease;
                `;
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>${type === 'error' ? '‚ùå' : 
                               type === 'warning' ? '‚ö†Ô∏è' : 
                               type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
                if (!document.getElementById('notification-styles')) {
                    const style = document.createElement('style');
                    style.id = 'notification-styles';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes slideOut {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(100%); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            } else {
                // –í Telegram WebApp –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                tg.showPopup({
                    title: type === 'error' ? '‚ùå –û—à–∏–±–∫–∞' : 
                          type === 'warning' ? '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ' : 
                          type === 'success' ? '‚úÖ –£—Å–ø–µ—à–Ω–æ' : '‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                    message: message,
                    buttons: [{ type: 'ok' }]
                });
            }
        }

        // ==================== –°–ò–ú–£–õ–Ø–¶–ò–Ø –î–õ–Ø –û–¢–õ–ê–î–ö–ò ====================
        function simulateDataFromBot() {
            // –¢–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
            const simulatedData = {
                temperature: (24.0 + Math.random() * 3).toFixed(1),
                humidity: (40.0 + Math.random() * 20).toFixed(1),
                light: Math.floor(100 + Math.random() * 2000),
                voltage: 5.0,
                signal_level: 85 + Math.floor(Math.random() * 15),
                fan_status: Math.random() > 0.5,
                motor_status: '–°–¢–û–ü',
                arduino_connected: true,
                sensor_connection: 'ARDUINO (DHT22 + BH1750)',
                light_text: '–•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ',
                timestamp: Date.now()
            };
            
            updateFromBotData(simulatedData);
        }

        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò TELEGRAM ====================
        if (tg) {
            tg.ready();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
            tg.onEvent('webAppDataReceived', (eventData) => {
                try {
                    const data = JSON.parse(eventData);
                    if (data.sensorData) {
                        updateFromBotData(data.sensorData);
                    } else if (data.error) {
                        showNotification(`–û—à–∏–±–∫–∞ –±–æ—Ç–∞: ${data.error}`, 'error');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞:', error);
                }
            });
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω–µ—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞)
            setInterval(() => {
                if (tg && systemState.data_age > CONFIG.SENSOR_TIMEOUT) {
                    tg.sendData(JSON.stringify({ action: 'ping' }));
                }
            }, CONFIG.AUTO_REFRESH);
        } else {
            // –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–∏–º—É–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            setInterval(() => {
                if (window.location.search.includes('debug')) {
                    simulateDataFromBot();
                }
            }, 10000);
        }

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ iframe –∏–ª–∏ –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–∞—Ö)
        window.updateSensorData = updateFromBotData;
        
        console.log('‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
        console.log('üì° –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Python –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Telegram WebApp...');
    </script>
</body>
</html>